var addCtrl=angular.module("addCtrl",["geolocation","gservice"]);addCtrl.controller("addCtrl",function(a,b,c,d,e){a.formData={};var f={};console.log("Add control in use"),a.formData.latitude=54.1772743,a.formData.longitude=-4.656563,d.getLocation().then(function(b){f={lat:b.coords.latitude,"long":b.coords.longitude},a.formData.longitude=parseFloat(f["long"]).toFixed(3),a.formData.latitude=parseFloat(f.lat).toFixed(3),a.formData.htmlverified="Yep (Thanks for giving us real data!)",e.refresh(a.formData.latitude,a.formData.longitude)}),c.$on("clicked",function(){a.$apply(function(){a.formData.latitude=parseFloat(e.clickLat).toFixed(5),a.formData.longitude=parseFloat(e.clickLong).toFixed(5),a.formData.htmlverified="Site selected"})}),a.createSite=function(){var c=JSON.stringify({date:a.formData.dateVisited}),d=JSON.parse(c);d.date=new Date(d.date);var f={siteName:a.formData.siteName,siteDesc:a.formData.siteDesc,dateVisited:d.date,siteCoords:[a.formData.longitude,a.formData.latitude],htmlverified:a.formData.htmlverified};b.post("/sites",f).success(function(b){a.formData.siteName="",a.formData.siteDesc="",a.formData.dateVisited="",a.formData.siteCoords="",e.refresh(a.formData.latitude,a.formData.longitude)}).error(function(a){console.log("Error: "+a)})},a.resetForm=function(){a.formData.siteName="",a.formData.siteDesc="",a.formData.dateVisited="",a.formData.longitude="",a.formData.latitude="",a.formData.htmlverified=""}});var app=angular.module("archaeologyApp",["addCtrl","editCtrl","queryCtrl","geolocation","gservice","ngRoute","mgcrea.ngStrap","flow","ngAnimate"]);app.config(function(a,b){a.when("/add-site",{controller:"addCtrl",templateUrl:"partials/addForm.html"}).when("/",{controller:"queryCtrl",templateUrl:"partials/queryForm.html"}).when("/edit-site",{controller:"editCtrl",templateUrl:"partials/editForm.html"}).otherwise({redirectTo:"/"}),angular.extend(b.defaults,{dateFormat:"yyyy-MM-dd",dateType:"iso",startWeek:1})});var editCtrl=angular.module("editCtrl",["geolocation","gservice"]);editCtrl.controller("editCtrl",function(a,b,c,d,e){a.editFormData={};var f={};a.searchData={},a.searchResults=[],console.log("Edit controller in use"),a.typeAhead=function(c){return a.entered=c,b.get("/typeahead-query",a.entered).then(function(b){a.searchData=b.data;var c=a.searchData;return a.siteNames=[],c.forEach(function(b){a.siteNames.push(b.siteName)}),a.siteNames})},a.getSite=function(c){console.log("function: getSite()");var d={};f={siteName:c},b.post("/site-edit-query",f).success(function(b){if(d=b[0]){new Date(d.dateVisited);a.siteId=d._id,a.formData.siteName=d.siteName,a.formData.siteDesc=d.siteDesc,a.formData.dateVisited=d.dateVisited,a.formData.latitude=d.siteCoords[1],a.formData.longitude=d.siteCoords[0],a.formData.htmlverified=d.htmlverified,e.refresh(a.formData.latitude,a.formData.longitude,b[0])}else console.log("not enough info to select a site.")}).error(function(a){console.log("Error: "+a)})},a.editSite=function(c){var d=JSON.stringify({date:a.formData.dateVisited}),f=JSON.parse(d);f.date=new Date(f.date),console.log("site id: "+c),console.log("dateObj: "+f),console.log("new date for saving: "+f.date);var g={siteId:c,siteName:a.formData.siteName,siteDesc:a.formData.siteDesc,dateVisited:f.date,siteCoords:[a.formData.longitude,a.formData.latitude],htmlverified:a.formData.htmlverified};console.log("Date visited: "+g.dateVisited),b.post("/site-edit",g).success(function(b){console.log("siteData posted"),e.refresh(a.formData.latitude,a.formData.longitude)}).error(function(a){console.log("Error: "+a)})}}),angular.module("gservice",[]).factory("gservice",function(a,b,c){var d={},e=[],f=54.215,g=-4.546;d.clickLat=0,d.clickLong=0,d.refresh=function(a,c,d){e=[],f=a,g=c,d?(e=h(d),i(a,c,!0)):b.get("/sites").success(function(b){e=h(b),i(a,c,!1)}).error(function(){})};var h=function(a){for(var b=[],d=0;d<a.length;d++){var e=a[d],f=new Date(e.dateVisited),g="<p><b>Site name</b>: "+e.siteName+"<br><b>Date visited</b>: "+c("date")(f,"h:mm on EEEE, d MMM yyyy GG")+"</p>";b.push({latlon:new google.maps.LatLng(e.siteCoords[1],e.siteCoords[0]),message:new google.maps.InfoWindow({content:g,maxWidth:320}),siteName:e.siteName,dateVisited:e.dateVisited,siteCoords:e.siteCoords})}return b},i=function(b,c,h){var i={lat:f,lng:g};console.log("LatLng: "+i.lat+", "+i.lng);var j={zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,rotateControl:!0},k="";if(console.log("no map"),k||(console.log("so we create one"),k=new google.maps.Map(document.getElementById("map"),{zoom:10,center:i,options:j,mapTypeId:google.maps.MapTypeId.TERRAIN})),h?icon="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png":icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",e.forEach(function(a,b){var c=new google.maps.Marker({position:a.latlon,map:k,title:"Big Map",icon:icon});google.maps.event.addListener(c,"click",function(b){currentSelectedMarker=a,a.message.open(k,c)})}),h){k.setZoom(10);var l=angular.element("#zoomButton");l?(console.log("zoom: "+angular.toJson(l,!0)),$("#zoomButton").on("click",function(){console.log("Clicked the zoom"),k.setZoom(16),k.setMapTypeId(google.maps.MapTypeId.SATELLITE)})):k.setZoom(10),k.panTo(new google.maps.LatLng(b,c)),google.maps.event.addListener(k,"click",function(b){var c=new google.maps.Marker({position:b.latLng,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker&&lastMarker.setMap(null),lastMarker=c,k.panTo(c.position),d.clickLat=c.getPosition().lat(),d.clickLong=c.getPosition().lng(),a.$broadcast("clicked")})}else{console.log("No filter active");var m=new google.maps.LatLng(b,c),n=new google.maps.Marker({position:m,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker=n,k.panTo(new google.maps.LatLng(b,c)),google.maps.event.addListener(k,"click",function(b){var c=new google.maps.Marker({position:b.latLng,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker&&lastMarker.setMap(null),lastMarker=c,k.setMapTypeId(google.maps.MapTypeId.SATELLITE),k.setZoom(18),k.panTo(c.position),d.clickLat=c.getPosition().lat(),d.clickLong=c.getPosition().lng(),a.$broadcast("clicked")})}};return google.maps.event.addDomListener(window,"load",d.refresh(f,g)),d}),angular.module("gservice",[]).factory("gservice",function(a,b){var c={},d=[],e=54.215,f=-4.546;c.clickLat=0,c.clickLong=0,c.refresh=function(a,c,i){d=[],e=a,f=c,i?(d=g(i),h(a,c,!0)):b.get("/sites").success(function(b){d=g(b),h(a,c,!1)}).error(function(){})};var g=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e="<p><b>Site name</b>: "+d.siteName+"<br><b>Date visited</b>: "+d.dateVisited+"</p>";b.push({latlon:new google.maps.LatLng(d.siteCoords[1],d.siteCoords[0]),message:new google.maps.InfoWindow({content:e,maxWidth:320}),siteName:d.siteName,dateVisited:d.dateVisited,siteCoords:d.siteCoords})}return b},h=function(b,g,h){var i={lat:e,lng:f};console.log("LatLng: "+i.lat+", "+i.lng);var j={zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,rotateControl:!0},k="";if(console.log("no map"),k||(console.log("so we create one"),k=new google.maps.Map(document.getElementById("map"),{zoom:10,center:i,options:j,mapTypeId:google.maps.MapTypeId.TERRAIN})),h?icon="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png":icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",d.forEach(function(a,b){var c=new google.maps.Marker({position:a.latlon,map:k,title:"Big Map",icon:icon});google.maps.event.addListener(c,"click",function(b){currentSelectedMarker=a,a.message.open(k,c)})}),h){k.setZoom(10);var l=angular.element("#zoomButton");l?(console.log("zoom: "+angular.toJson(l,!0)),$("#zoomButton").on("click",function(){console.log("Clicked the zoom"),k.setZoom(16),k.setMapTypeId(google.maps.MapTypeId.SATELLITE)})):k.setZoom(10),k.panTo(new google.maps.LatLng(b,g)),google.maps.event.addListener(k,"click",function(b){var d=new google.maps.Marker({position:b.latLng,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker&&lastMarker.setMap(null),lastMarker=d,k.panTo(d.position),c.clickLat=d.getPosition().lat(),c.clickLong=d.getPosition().lng(),a.$broadcast("clicked")})}else{console.log("No filter active");var m=new google.maps.LatLng(b,g),n=new google.maps.Marker({position:m,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker=n,k.panTo(new google.maps.LatLng(b,g)),google.maps.event.addListener(k,"click",function(b){var d=new google.maps.Marker({position:b.latLng,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker&&lastMarker.setMap(null),lastMarker=d,k.setMapTypeId(google.maps.MapTypeId.SATELLITE),k.setZoom(18),k.panTo(d.position),c.clickLat=d.getPosition().lat(),c.clickLong=d.getPosition().lng(),a.$broadcast("clicked")})}};return google.maps.event.addDomListener(window,"load",c.refresh(e,f)),c}),angular.module("gservice",[]).factory("gservice",function(a,b){var c={},d=[],e=54.215,f=-4.546;c.clickLat=0,c.clickLong=0,c.refresh=function(a,c,i){d=[],e=a,f=c,i?(d=g(i),h(a,c,!0)):b.get("/sites").success(function(b){d=g(b),h(a,c,!1)}).error(function(){})};var g=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e="<p><b>Site name</b>: "+d.siteName+"<br><b>Date visited</b>: "+d.dateVisited+"</p>";b.push({latlon:new google.maps.LatLng(d.siteCoords[1],d.siteCoords[0]),message:new google.maps.InfoWindow({content:e,maxWidth:320}),siteName:d.siteName,dateVisited:d.dateVisited,siteCoords:d.siteCoords})}return b},h=function(b,g,h){var i={lat:e,lng:f};console.log("LatLng: "+i.lat+", "+i.lng);var j={zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,rotateControl:!0},k="";if(console.log("no map"),k||(console.log("so we create one"),k=new google.maps.Map(document.getElementById("map"),{zoom:10,center:i,options:j,mapTypeId:google.maps.MapTypeId.TERRAIN})),h?icon="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png":icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",d.forEach(function(a,b){var c=new google.maps.Marker({position:a.latlon,map:k,title:"Big Map",icon:icon});google.maps.event.addListener(c,"click",function(b){currentSelectedMarker=a,a.message.open(k,c)})}),h){k.setZoom(16),k.setMapTypeId(google.maps.MapTypeId.SATELLITE);var l=$("#zoomButton");l?(console.log("zoom: "+l),$("#zoomButton").click(function(){console.log("Clicked the zoom"),k.setZoom(16)})):k.setZoom(16),k.panTo(new google.maps.LatLng(b,g))}else{console.log("No filter active");var m=new google.maps.LatLng(b,g),n=new google.maps.Marker({position:m,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker=n,k.panTo(new google.maps.LatLng(b,g)),google.maps.event.addListener(k,"click",function(b){var d=new google.maps.Marker({position:b.latLng,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker&&lastMarker.setMap(null),lastMarker=d,k.setMapTypeId(google.maps.MapTypeId.SATELLITE),k.setZoom(18),k.panTo(d.position),c.clickLat=d.getPosition().lat(),c.clickLong=d.getPosition().lng(),a.$broadcast("clicked")})}};return google.maps.event.addDomListener(window,"load",c.refresh(e,f)),c}),angular.module("gservice",[]).factory("gservice",function(a,b){var c={},d=[],e=54.215,f=-4.546;c.clickLat=0,c.clickLong=0,c.refresh=function(a,c,i){d=[],e=a,f=c,i?(d=g(i),h(a,c,!0)):b.get("/sites").success(function(b){d=g(b),h(a,c,!1)}).error(function(){})};var g=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e="<p><b>Site name</b>: "+d.siteName+"<br><b>Date visited</b>: "+d.dateVisited+"</p>";b.push({latlon:new google.maps.LatLng(d.siteCoords[1],d.siteCoords[0]),message:new google.maps.InfoWindow({content:e,maxWidth:320}),siteName:d.siteName,dateVisited:d.dateVisited,siteCoords:d.siteCoords})}return b},h=function(b,g,h){var i={lat:e,lng:f};console.log("LatLng: "+i.lat+", "+i.lng);var j={zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,rotateControl:!0},k="";if(console.log("no map"),k||(console.log("so we create one"),k=new google.maps.Map(document.getElementById("map"),{zoom:10,center:i,options:j,mapTypeId:google.maps.MapTypeId.TERRAIN})),h?icon="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png":icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",d.forEach(function(a,b){var c=new google.maps.Marker({position:a.latlon,map:k,title:"Big Map",icon:icon});google.maps.event.addListener(c,"click",function(b){currentSelectedMarker=a,a.message.open(k,c)})}),h){k.setZoom(10);var l=$("#zoomButton");l?(console.log("zoom: "+l),l.on("click",function(){console.log("Clicked the zoom"),k.setZoom(16),k.setMapTypeId(google.maps.MapTypeId.SATELLITE)})):k.setZoom(10),k.panTo(new google.maps.LatLng(b,g))}else{console.log("No filter active");var m=new google.maps.LatLng(b,g),n=new google.maps.Marker({position:m,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker=n,k.panTo(new google.maps.LatLng(b,g)),google.maps.event.addListener(k,"click",function(b){var d=new google.maps.Marker({position:b.latLng,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker&&lastMarker.setMap(null),lastMarker=d,k.setMapTypeId(google.maps.MapTypeId.SATELLITE),k.setZoom(18),k.panTo(d.position),c.clickLat=d.getPosition().lat(),c.clickLong=d.getPosition().lng(),a.$broadcast("clicked")})}};return google.maps.event.addDomListener(window,"load",c.refresh(e,f)),c}),angular.module("gservice",[]).factory("gservice",function(a,b){var c={},d=[],e=54.215,f=-4.546;c.clickLat=0,c.clickLong=0,c.refresh=function(a,c,i){d=[],e=a,f=c,i?(d=g(i),h(a,c,!0)):b.get("/sites").success(function(b){d=g(b),h(a,c,!1)}).error(function(){})};var g=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e="<p><b>Site name</b>: "+d.siteName+"<br><b>Date visited</b>: "+d.dateVisited+"</p>";b.push({latlon:new google.maps.LatLng(d.siteCoords[1],d.siteCoords[0]),message:new google.maps.InfoWindow({content:e,maxWidth:320}),siteName:d.siteName,dateVisited:d.dateVisited,siteCoords:d.siteCoords})}return b},h=function(b,g,h){var i={lat:e,lng:f};console.log("LatLng: "+i.lat+", "+i.lng);var j={zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,rotateControl:!0},k="";if(console.log("no map"),k||(console.log("so we create one"),k=new google.maps.Map(document.getElementById("map"),{zoom:10,center:i,options:j,mapTypeId:google.maps.MapTypeId.TERRAIN})),h?icon="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png":icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",d.forEach(function(a,b){var c=new google.maps.Marker({position:a.latlon,map:k,title:"Big Map",icon:icon});google.maps.event.addListener(c,"click",function(b){currentSelectedMarker=a,a.message.open(k,c)})}),h){k.setZoom(10);var l=angular.element("#zoomButton");l?(console.log("zoom: "+angular.toJson(l,!0)),$("#zoomButton").on("click",function(){console.log("Clicked the zoom"),k.setZoom(16)})):k.setZoom(16),k.panTo(new google.maps.LatLng(b,g)),google.maps.event.addListener(k,"click",function(b){var d=new google.maps.Marker({position:b.latLng,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker&&lastMarker.setMap(null),lastMarker=d,k.panTo(d.position),c.clickLat=d.getPosition().lat(),c.clickLong=d.getPosition().lng(),a.$broadcast("clicked")})}else{console.log("No filter active");var m=new google.maps.LatLng(b,g),n=new google.maps.Marker({position:m,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker=n,k.panTo(new google.maps.LatLng(b,g)),google.maps.event.addListener(k,"click",function(b){var d=new google.maps.Marker({position:b.latLng,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker&&lastMarker.setMap(null),lastMarker=d,k.setMapTypeId(google.maps.MapTypeId.SATELLITE),k.setZoom(18),k.panTo(d.position),c.clickLat=d.getPosition().lat(),c.clickLong=d.getPosition().lng(),a.$broadcast("clicked")})}};return google.maps.event.addDomListener(window,"load",c.refresh(e,f)),c});var queryCtrl=angular.module("queryCtrl",["geolocation","gservice","vAccordion"]);queryCtrl.controller("queryCtrl",function(a,b,c,d,e,f,g){a.formData={};var h={};console.log("Query control in use"),f.getLocation().then(function(b){coords={lat:b.coords.latitude,"long":b.coords.longitude},a.formData.longitude=parseFloat(coords["long"]).toFixed(3),a.formData.latitude=parseFloat(coords.lat).toFixed(3)}),e.$on("clicked",function(){a.$apply(function(){a.formData.latitude=parseFloat(g.clickLat).toFixed(3),a.formData.longitude=parseFloat(g.clickLong).toFixed(3)})}),a.querySites=function(){return console.log("Querying (searching) sites"),h={siteName:a.formData.siteName,siteDesc:a.formData.siteDesc},c.post("/query",h).success(function(b){console.log("QuerySiteBody:"),console.log(h),console.log("QuerySiteResults:"),console.log(b.length),g.refresh(b[0].siteCoords[1],b[0].siteCoords[0],b),a.queryCount=b.length}).error(function(a){console.log("Error "+a)}),g},a.resetMap=function(){g.refresh(a.formData.latitude,a.formData.longitude)},a.resetForm=function(){a.formData.siteName="",a.formData.siteDesc=""},a.selectSite=function(a){console.log("Selecting site");var b=a;console.log("Site clicked: "+b),h={_id:b},c.post("/site-query",h).success(function(a){console.log("Select site QueryBody:"),console.log(a),g.refresh(a[0].siteCoords[1],a[0].siteCoords[0],a)})},c.get("/sites").success(function(b){a.sites=b,console.log("all sites data: "+b)})});