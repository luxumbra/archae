var addCtrl=angular.module("addCtrl",["geolocation","gservice"]);addCtrl.controller("addCtrl",function(a,b,c,d,e){a.formData={};var f={};a.formData.latitude=54.1772743,a.formData.longitude=-4.656563,d.getLocation().then(function(b){f={lat:b.coords.latitude,"long":b.coords.longitude},a.formData.longitude=parseFloat(f["long"]).toFixed(3),a.formData.latitude=parseFloat(f.lat).toFixed(3),a.formData.htmlverified="Yep (Thanks for giving us real data!)",e.refresh(a.formData.latitude,a.formData.longitude)}),c.$on("clicked",function(){a.$apply(function(){a.formData.latitude=parseFloat(e.clickLat).toFixed(3),a.formData.longitude=parseFloat(e.clickLong).toFixed(3),a.formData.htmlverified="Site selected"})}),a.createSite=function(){var c={siteName:a.formData.siteName,siteDesc:a.formData.siteDesc,dateVisited:a.formData.dateVisited,siteCoords:[a.formData.longitude,a.formData.latitude],htmlverified:a.formData.htmlverified};b.post("/sites",c).success(function(b){a.formData.siteName="",a.formData.siteDesc="",a.formData.dateVisited="",a.formData.siteCoords="",e.refresh(a.formData.latitude,a.formData.longitude)}).error(function(a){console.log("Error: "+a)})}});var app=angular.module("archaeologyApp",["addCtrl","queryCtrl","geolocation","gservice","ngRoute"]);app.config(function(a){a.when("/add-site",{controller:"addCtrl",templateUrl:"partials/addForm.html"}).when("/",{controller:"queryCtrl",templateUrl:"partials/queryForm.html"}).otherwise({redirectTo:"/"})}),angular.module("gservice",[]).factory("gservice",function(a,b){var c={},d=[],e=54.215,f=-4.546;c.clickLat=0,c.clickLong=0,c.refresh=function(a,c,i){d=[],e=a,f=c,i?(d=g(i),h(a,c,!0)):b.get("/sites").success(function(b){d=g(b),h(a,c,!1)}).error(function(){})};var g=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e="<p><b>Site name</b>: "+d.siteName+"<br><b>Date visited</b>: "+d.dateVisited+"</p>";b.push({latlon:new google.maps.LatLng(d.siteCoords[1],d.siteCoords[0]),message:new google.maps.InfoWindow({content:e,maxWidth:320}),siteName:d.siteName,dateVisited:d.dateVisited,siteCoords:d.siteCoords})}return b},h=function(b,g,h){var i={lat:e,lng:f},j={zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,rotateControl:!0},k="";if(console.log("no map"),k||(console.log("create one"),k=new google.maps.Map(document.getElementById("map"),{zoom:10,center:i,options:j,mapTypeId:google.maps.MapTypeId.TERRAIN})),h?icon="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png":icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",d.forEach(function(a,b){var c=new google.maps.Marker({position:a.latlon,map:k,title:"Big Map",icon:icon});google.maps.event.addListener(c,"click",function(b){currentSelectedMarker=a,a.message.open(k,c)})}),h)google.maps.event.addListener(k,"click",function(b){k.panTo(queryResults[0].siteCoords[1],queryResults[0].siteCoords[0]),c.clickLat=m.getPosition().lat(),c.clickLong=m.getPosition().lng(),a.$broadcast("clicked")});else{var l=new google.maps.LatLng(b,g),m=new google.maps.Marker({position:l,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker=m,k.panTo(new google.maps.LatLng(b,g)),google.maps.event.addListener(k,"click",function(b){var d=new google.maps.Marker({position:b.latLng,animation:google.maps.Animation.BOUNCE,map:k,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});lastMarker&&lastMarker.setMap(null),lastMarker=d,k.setMapTypeId(google.maps.MapTypeId.SATELLITE),k.setZoom(18),k.panTo(d.position),c.clickLat=d.getPosition().lat(),c.clickLong=d.getPosition().lng(),a.$broadcast("clicked")})}};return google.maps.event.addDomListener(window,"load",c.refresh(e,f)),c});var queryCtrl=angular.module("queryCtrl",["geolocation","gservice","vAccordion"]);queryCtrl.controller("queryCtrl",function(a,b,c,d,e,f){a.formData={};var g={};e.getLocation().then(function(b){coords={lat:b.coords.latitude,"long":b.coords.longitude},a.formData.longitude=parseFloat(coords["long"]).toFixed(3),a.formData.latitude=parseFloat(coords.lat).toFixed(3)}),d.$on("clicked",function(){a.$apply(function(){a.formData.latitude=parseFloat(f.clickLat).toFixed(3),a.formData.longitude=parseFloat(f.clickLong).toFixed(3)})}),a.querySites=function(){g={siteName:a.formData.siteName,siteDesc:a.formData.siteDesc},c.post("/query",g).success(function(b){f.refresh(a.formData.latitude,a.formData.longitude,b),a.queryCount=b.length}).error(function(a){console.log("Error "+a)})},a.resetMap=function(){f.refresh(a.formData.latitude,a.formData.longitude)},a.resetForm=function(){a.formData.siteName="",a.formData.siteDesc=""},a.selectSite=function(a){var b=a;console.log("Site clicked: "+b),g={_id:b},c.post("/site-query",g).success(function(a){console.log("QueryBody:"),console.log(a),f.refresh(a[0].siteCoords[1],a[0].siteCoords[0],a)})},c.get("/sites").success(function(b){a.sites=b,console.log(b)})});